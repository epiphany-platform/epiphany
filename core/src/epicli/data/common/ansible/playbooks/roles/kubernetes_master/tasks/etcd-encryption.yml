---
# Master node specific

# Setup etcd encryption

- name: Check if etcd encryption configuration exists
  stat:
    path: /etc/kubernetes/pki/etcd/etc-encryption.conf
  register: etcd_conf_file

- name: Etcd encryption
  shell: "head -c 32 /dev/urandom | base64"
  register: random_secret
  when:
    - groups['kubernetes_master'][0] == inventory_hostname
    - not etcd_conf_file.stat.exists

- name: Show random secret
  debug:
    msg: "{{ random_secret.stdout }}"
  when:
    - groups['kubernetes_master'][0] == inventory_hostname
    - not etcd_conf_file.stat.exists

- name: Create etcd encryption config
  become: yes
  template:
    dest: "/etc/kubernetes/pki/etcd/etc-encryption.conf"
    src: etc-encryption.conf.j2
    owner: root
    group: root
    mode: 0644
  when:
    - groups['kubernetes_master'][0] == inventory_hostname
    - not etcd_conf_file.stat.exists

- name: Change kube apiserver configuration
  lineinfile:
    path: /etc/kubernetes/manifests/kube-apiserver.yaml
    insertafter: '^    - kube-apiserver$'
    line: '    - --encryption-provider-config=/etc/kubernetes/pki/etcd/etc-encryption.conf'
    backup: yes
  when:
    - groups['kubernetes_master'][0] == inventory_hostname

- name: Apply kubernetes-dashboard.yml
  shell: kubectl --kubeconfig=/home/{{ specification.admin_user.name }}/.kube/config get secrets --all-namespaces -o json | kubectl replace -f -
  become_user: "{{ specification.admin_user.name }}"
  when:
    - groups['kubernetes_master'][0] == inventory_hostname
