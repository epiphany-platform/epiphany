---
- name: Install PostgreSQL packages ({{ ansible_os_family }})
  yum:
    name:
      - rh-postgresql10-postgresql
      - rh-postgresql10-postgresql-syspaths
      - rh-postgresql10-postgresql-server
      - rh-postgresql10-postgresql-server-syspaths
      - rh-postgresql10-postgresql-contrib
      - rh-postgresql10-postgresql-contrib-syspaths
      - rh-postgresql10-postgresql-libs
      - python-psycopg2 # required for postresql ansible management
    update_cache: yes
    state: present

# --- additional components ---

- name: Install pgbouncer package
  yum:
    name:
      - pgbouncer
    state: present
    update_cache: yes
  when:
    - specification.additional_components.pgbouncer.enabled is defined
    - specification.additional_components.pgbouncer.enabled

# --- extensions ---

- name: Get information about installed packages as facts
  package_facts:
    manager: auto
  when: ansible_facts.packages is undefined

- name: Install pgaudit package
  yum:
    name:
      - pgaudit12_10-1.2.0 # cannot install 1.2.2-1 due to dependency conflict, see issue #1742
    state: present
  when:
    - specification.extensions.pgaudit.enabled is defined
    - specification.extensions.pgaudit.enabled
    - (ansible_facts.packages['pgaudit12_10'] is undefined or
       ansible_facts.packages['pgaudit12_10'][0].version is version('1.2.0', '<='))
