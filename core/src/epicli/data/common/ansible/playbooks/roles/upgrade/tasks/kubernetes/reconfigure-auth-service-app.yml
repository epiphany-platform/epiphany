---
- name: "Change keycloak stateful set to use {{ image_registry_address }}"
  run_once: true
  environment:
    KUBECONFIG: /home/{{ admin_user.name }}/.kube/config
  block:
    - name: upgrade-master | Get keycloak statefulset name
      shell: |-
        kubectl get statefulsets.apps --all-namespaces -o=jsonpath={{ _jsonpath }} |
        grep -i keycloak |
        awk '{print $1}'
      vars:
        _jsonpath: >-
          '{range .items[*]}{.metadata.name}{"\t"}{.spec.template.spec.containers[].image}{"\n"}{end}'
      changed_when: false
      register: keycloak_ss_name
      args: &args
        executable: /bin/bash

    - name: upgrade-master | Get keycloak namespace
      shell: |-
        kubectl get statefulsets.apps --all-namespaces -o=jsonpath={{ _jsonpath }} |
        grep -i keycloak |
        awk '{print $1}'
      vars:
        _jsonpath: >-
          '{range .items[*]}{.metadata.namespace}{"\t"}{.spec.template.spec.containers[].image}{"\n"}{end}'
      changed_when: false
      register: keycloak_namespace
      args: *args

    - name: upgrade-master | Get keycloak image
      shell: |-
        kubectl get statefulsets.apps {{ keycloak_ss_name.stdout }} -n {{ keycloak_namespace.stdout }} -o=jsonpath={{ _jsonpath }}
      vars:
        _jsonpath: >-
          '{$.spec.template.spec.containers[:1].image}'
      changed_when: false
      register: keycloak_repository
      when:
        - not keycloak_namespace.stdout == ""

    - name: upgrade-master | Patch keycloak to use {{ image_registry_address }}
      shell: |-
        kubectl patch statefulsets.apps {{ keycloak_ss_name.stdout }} -n {{ keycloak_namespace.stdout }} --patch '{{ _patch | to_json }}'
      vars:
        _patch:
          spec:
            template:
              spec:
                containers:
                  - name: "{{ keycloak_ss_name.stdout }}"
                    image: "{{ image_registry_address }}/{{ keycloak_repository.stdout }}"
      when:
        - not keycloak_namespace.stdout == ""
        - not image_registry_address in keycloak_repository.stdout
