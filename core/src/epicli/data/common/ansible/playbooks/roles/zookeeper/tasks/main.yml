---
# Zookeeper tasks - resides on masters

- name: Create Zookeeper group
  group:
    name: "{{ zookeeper_group }}"
    system: yes

- name: Create Zookeeper user
  user:
    name: "{{ zookeeper_user }}"
    group: "{{ zookeeper_group }}"
    system: yes
    shell: "/usr/sbin/nologin"

- name: Install Java package
  package:
    name: "java-1.8.0-openjdk"
    state: present
  when: ansible_os_family == "RedHat"

- name: Install Java package
  package:
    name: "openjdk-8-jre"
    state: present
  when: ansible_os_family == "Debian"

- name: Check if jmx exporter is available
  stat:
    path: "{{ prometheus_jmx_path }}"
  register: exporter

- name: Set zookeeper variable with version name
  set_fact:
    zookeeper_name: "zookeeper-{{ specification.version }}"
  changed_when: false

- name: Set zookeeper install dir for {{ zookeeper_name }}
  set_fact:
    zookeeper_install_dir: "/opt/{{ zookeeper_name }}"
  changed_when: false

- name: Set Zookeeper file name to install
  set_fact:
    zookeeper_file_name: "{{ specification.file_name }}"

- name: Download Zookeeper binaries
  include_role:
    name: download
    tasks_from: download_file
  vars:
    file_name: "{{ zookeeper_file_name }}"

- name: Create {{ zookeeper_install_dir }} directories
  become: yes
  file:
    path: "{{ item }}"
    recurse: yes
    owner: "{{ zookeeper_user }}"
    group: "{{ zookeeper_group }}"
    mode: 0750
    state: directory
  with_items:
  - "{{ zookeeper_install_dir }}"

- name: Unpack {{ zookeeper_name }} binary
  become: true
  unarchive:
    remote_src: yes
    src: "{{ download_directory }}/{{ zookeeper_file_name }}"
    dest: "{{ zookeeper_install_dir }}"
    creates: "{{ zookeeper_install_dir }}/bin"
    extra_opts: [--strip-components=1]
    mode: 0755
    owner: "{{ zookeeper_user }}"
    group: "{{ zookeeper_group }}"
  check_mode: false

- name: "Create zookeeper {{item}} directory."
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ zookeeper_user }}"
    group: "{{ zookeeper_group }}"
  with_items:
    - "{{ zookeeper_data_dir }}"
    - "{{ zookeeper_log_dir }}"
    - "{{ zookeeper_install_dir }}/conf"
    - "/etc/zookeeper/conf"

- name: Systemd script.
  template:
    src: zookeeper.service.j2
    dest: /lib/systemd/system/zookeeper.service
  when: ansible_service_mgr == 'systemd'
  notify:
    - Reload systemctl daemon
    - Restart zookeeper

- name: Set Zookeeper server id
  copy:
    content: "{{ (groups.zookeeper.index(inventory_hostname) + 1) }}\n"
    dest: /var/lib/zookeeper/myid
    owner: "{{ zookeeper_user }}"
    group: "{{ zookeeper_group }}"
  notify: Restart zookeeper

- name: Configure Zookeeper
  template:
    src: zoo.j2
    dest: "{{ zookeeper_install_dir }}/conf/zoo.cfg"
    owner: "{{ zookeeper_user }}"
    group: "{{ zookeeper_group }}"
  notify: Restart zookeeper

- name: Link /opt/zookeeper to the right version
  file: path=/opt/zookeeper state=link src="{{ zookeeper_install_dir }}"

# - name: Link /etc/zookeeper/conf to /opt/zookeeper/config
#   file: path=/etc/zookeeper/conf state=link src=/opt/zookeeper/conf

- name: Add Zookeeper's bin dir to the PATH
  copy:
    content: "export PATH=$PATH:/opt/zookeeper/bin"
    dest: "/etc/profile.d/zookeeper_path.sh"
    mode: 0755

- name: Update the log4j config with saner production values
  template:
    src: log4j.properties.j2
    dest: "{{ zookeeper_install_dir }}/conf/log4j.properties"
  notify:
    - Restart zookeeper

- name: Enable Zookeeper service
  service:
    name: zookeeper
    enabled: yes

- name: Start Zookeeper
  service:
    name: zookeeper
    state: started
    enabled: yes

- include_tasks: metrics.yml
  when: exporter.stat.exists

