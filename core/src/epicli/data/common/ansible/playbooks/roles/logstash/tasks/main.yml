---
- name: Install OS packages
  package:
    name: "{{ _packages[ansible_os_family] }}"
    state: present
  vars:
    _packages:
      # Bundled with ElasticSearch OpenJDK 15 doesn't work correctly with Logstash
      # as there are startup options that are deprecated in OpenJDK 15 such as UseConcMarkSweepGC
      Debian:
        - openjdk-8-jre-headless
        - logstash-oss={{ versions[ansible_os_family] }}
      RedHat:
        - java-1.8.0-openjdk-headless
        - logstash-oss-{{ versions[ansible_os_family] }}
  module_defaults:
    yum: { lock_timeout: "{{ yum_lock_timeout }}" }

- name: Populate service facts
  service_facts:

- name: Create logstash systemd service
  command: /usr/share/logstash/bin/system-install /etc/logstash/startup.options systemd
  when:
    - "'logstash.service' not in ansible_facts.services"

- name: Ensure Logstash is disabled
  systemd:
    name: logstash
    enabled: false
    state: stopped

- name: Provide logstash-export.conf template file
  copy:
    src: logstash-export.conf.template
    dest: /etc/logstash/logstash-export.conf.template
