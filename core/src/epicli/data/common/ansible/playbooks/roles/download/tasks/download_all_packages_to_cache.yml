---
- name: Prepare list of packages to download
  block:
    - name: download_all_packages_to_cache | Clear list
      set_fact:
        packages: []
    - name: download_all_packages_to_cache | Prepare list of packages
      set_fact:
        packages: >-
          {{ packages + [ item | combine({ 'cached_file_path': specification.local_downloads_dir + '/'
                                                               + relative_dest_path,
                                           'checksum_algorithm': 'sha256' if item.sha256 is defined
                                                                          else 'sha512',
                                           'distro_version': item.distro_version | string,
                                           'version': item.version | string }) ] }}
      vars:
        relative_dest_path: >-
          {{ 'packages/' + item.arch + '/' + item.distro + '/' + item.distro_version + '/' + (item.url | basename) }}
      loop: >-
        [ {% for package_id in specification.downloads.packages.keys() %}
            {% for arch in specification.downloads.packages[package_id].keys() %}
              {% for package_item in specification.downloads.packages[package_id][arch] if 'url' in package_item %}
                {% for distro in ([ package_item.distros ] if package_item.distros is string
                                                           else package_item.distros) %}
                  { 'arch': '{{ arch }}', 'distro': '{{ distro }}',
                    'distro_version': '{{ package_item.distro_version }}',
                    'id': '{{ package_id }}',
                    {% if 'sha256' in package_item %}
                      'sha256': '{{ package_item.sha256 }}',
                    {% else %}
                      'sha512': '{{ package_item.sha512 }}',
                    {% endif %}
                    'url': '{{ package_item.url }}',
                    'version': '{{ package_item.version }}' },
                {% endfor %}
              {% endfor %}
            {% endfor %}
          {% endfor %} ]

- name: download_all_packages_to_cache | Download packages
  include_tasks: download_file_to_cache.yml
  vars:
    file_arg: "{{ item }}"
  loop: "{{ packages }}"