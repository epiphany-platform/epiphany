---
# tasks file for ignite
- name: add ignite group
  become: yes
  become_user: root
  group:
    name: ignite
    state: present

- name: add ignite user
  become: yes
  become_user: root
  user:
    name: ignite
    group: ignite
    home: '{{ ignite_home }}'


- name: Install Java package
  package:
    name: "java-1.8.0-openjdk-headless"
    state: present
  when: ansible_os_family == "RedHat"

- name: Install Java package
  package:
    name: "openjdk-8-jre-headless"
    state: present
  when: ansible_os_family == "Debian"

- name: Set Apache Ignite file name to install
  set_fact:
    ignite_file_name: "{{ specification.deployment.machine.file_name }}"

- name: Check if Ignite in current version exists
  stat:
    path: /opt/ignite_{{ specification.deployment.machine.version }}/bin/ignite.sh
  register: ignite_exists

- name: Download Ignite binaries
  include_role:
    name: download
    tasks_from: download_file
  vars:
    file_name: "{{ ignite_file_name }}"
  when: not ignite_exists.stat.exists

- name: Uncompress the Ignite archive
  unarchive:
    remote_src: yes
    creates: /opt/ignite_{{ specification.deployment.machine.version }}
    src: "{{ download_directory }}/{{ ignite_file_name }}"
    dest: /opt/ignite_{{ specification.deployment.machine.version }}
    owner: ignite
    extra_opts: [--strip-components=1]
  when: not ignite_exists.stat.exists

- name: Link /opt/ignite to the right version
  file:
    dest: /opt/ignite
    state: link
    src: /opt/ignite_{{ specification.deployment.machine.version }}

- name: Create Ignite config
  template:
    dest: /opt/ignite/config
    owner: ignite
    group: ignite
    mode: 0644
    src: default-config.xml.j2

- name: Create systemd service
  template:
    dest: /etc/systemd/system/ignite.service
    owner: ignite
    group: ignite
    mode: 0644
    src: ignite.service.j2
  register: ignite_systemd_service_created

- name: systemctl daemon-reload
  become: yes
  become_user: root
  systemd:
    daemon_reload: yes
  when: ignite_systemd_service_created is changed

- name: start ignite
  become: yes
  become_user: root
  service:
    name: ignite
    enabled: yes
    state: started