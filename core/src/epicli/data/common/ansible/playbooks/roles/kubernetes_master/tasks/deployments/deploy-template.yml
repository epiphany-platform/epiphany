---
# This file is meant to be also used by upgrade role

- name: Apply manifest
  become: false
  delegate_to: localhost
  run_once: true
  vars:
    dest_path: "{{ epiphany_manifests_dir }}/{{ file_name | basename | regex_replace('\\.j2$') }}"
  block:
    - name: Ensure that directory exists
      delegate_to: localhost
      file:
        path: "{{ epiphany_manifests_dir }}"
        state: directory
        mode: u=rwx,go=rx

    - name: Upload {{ file_name }} file
      template:
        src: "{{ file_name }}"
        dest: "{{ dest_path }}"
        mode: u=rw,g=r,o=

    - name: Apply {{ dest_path }} file
      command: kubectl apply -f {{ dest_path }}
      register: kubectl_apply
      changed_when: kubectl_apply.stdout_lines | map('regex_replace', '^.+ ') | reject('eq', 'unchanged') | list
