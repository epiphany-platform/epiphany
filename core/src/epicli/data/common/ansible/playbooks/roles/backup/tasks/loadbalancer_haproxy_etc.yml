---
- name: Set helper facts
  set_fact:
    snapshot_name: >-
      {{ ansible_date_time.iso8601_basic_short | replace('T','-') }}

- debug: var=snapshot_name

- name: Create and copy etc archive to backup destination
  always:
    - name: Delete etc archive (cleanup)
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ backup_dir }}/haproxy_etc_{{ snapshot_name }}.tar.gz"
        - "{{ backup_dir }}/haproxy_etc_{{ snapshot_name }}.tar.gz.sha1"

  block:
    - name: Ensure backup dir exists
      file:
        path: "{{ backup_dir }}/"
        state: directory

    - name: Create etc archive
      archive:
        dest: "{{ backup_dir }}/haproxy_etc_{{ snapshot_name }}.tar.gz"
        path:
          - /etc/haproxy/  # keep the / here!
          - /etc/ssl/haproxy/  # keep the / here!
        format: gz

    - name: Calculate checksum from etc archive
      stat:
        path: "{{ backup_dir }}/haproxy_etc_{{ snapshot_name }}.tar.gz"
        get_attributes: false
        get_checksum: true
        get_mime: false
        checksum_algorithm: sha1
      register: stat_etc_archive

    - name: Store etc archive checksum in a file
      copy:
        dest: "{{ backup_dir }}/haproxy_etc_{{ snapshot_name }}.tar.gz.sha1"
        content: |
          {{ stat_etc_archive.stat.checksum }}  haproxy_etc_{{ snapshot_name }}.tar.gz

    - name: Transfer etc archive via rsync
      import_tasks: download_via_rsync.yml
      vars:
        artifacts:
          - "{{ backup_dir }}/haproxy_etc_{{ snapshot_name }}.tar.gz"
          - "{{ backup_dir }}/haproxy_etc_{{ snapshot_name }}.tar.gz.sha1"
