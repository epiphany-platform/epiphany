---

- name: Initialize list of users
  set_fact:
    users:
    - admin
    - operator
    - reader

- name: Get Tokens from the server
  environment:
    KUBECONFIG: "/home/{{ admin_user.name }}/.kube/config"
  shell: kubectl describe secret $(kubectl get secrets --namespace=kube-system | grep {{item}} | awk '{print $1}') --namespace=kube-system | grep -E '^token' | awk '{print $2}' | head -1
  register: token_results
  loop: "{{ users }}"
  no_log: True

- name: Encrypt tokens
  environment:
    ANSIBLE_VAULT_PASSWORD_FILE: "{{ vault_tmp_file_location }}"
  delegate_to: localhost
  command: ansible-vault encrypt_string "{{ item.stdout }}"
  register: tokens_encrypted
  loop: "{{ token_results.results | list }}"
  no_log: True

- name: debug encrypted
  debug: 
    var: tokens_encrypted

- name: Combine tokens with users
  set_fact:
    user_credentials: "{{ user_credentials | default([]) + [dict(name=item[0], token=item[1].stdout)] }}"
  loop: "{{ users | zip(tokens_encrypted.results) | list }}"
  no_log: True

- name: Get Cluster config
  environment:
    KUBECONFIG: "/home/{{ admin_user.name }}/.kube/config"
  shell: kubectl config view --flatten --minify
  register: config_result
  no_log: True

- name: set config variable
  set_fact:
    cluster_configuration: "{{ config_result.stdout | from_yaml }}"

- name: Encrypt ca data
  environment:
    ANSIBLE_VAULT_PASSWORD_FILE: "{{ vault_tmp_file_location }}"
  delegate_to: localhost
  command: ansible-vault encrypt_string "{{ item.cluster['certificate-authority-data'] }}"
  register: clusters_ca_data
  loop: "{{ cluster_configuration.clusters }}"
  no_log: True

- name: set config variable
  set_fact:
    clusters_ca_data_encrypted: "{{ clusters_ca_data.results | list }}"

- name: debug cluster_config
  debug: 
    msg: "{{ cluster_configuration.clusters }}"

- name: debug clusters_ca_data
  debug: 
    msg: "{{ clusters_ca_data_encrypted }}"

- name: Set credentials file
  delegate_to: localhost
  template:
    dest: "{{ vault_location }}/kubernetes-secrets.yml"
    src: "kubernetes-secrets.yml.j2"
    mode: 0644
