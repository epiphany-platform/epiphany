---

- name: Download and unpack Helm binary
  unarchive: 
    src: "{{ apache_epirepo_path }}/files/helm-{{ helm_version }}-linux-amd64.tar.gz"
    dest: "/usr/local/bin"
    extra_opts:
      - --strip=1
      - --wildcards
      - '*/helm'
    remote_src: yes

- name: Create Helm binary file symlink (RHEL) 
  file:
    src: "/usr/local/bin/helm"
    dest: /usr/local/sbin/helm
    state: link

- name: Get list of Helm repos 
  become: yes
  shell: 'helm repo list | grep {{ helm_chart_repo_name }} || :'
  register: helm_repo

- name: Check if files exist in {{ apache_epirepo_path }}/helm-charts
  become: yes
  shell: 'ls {{ apache_epirepo_path }}/helm-charts/system | wc -l'
  register: helm_charts_files_number

- name: "Add Helm chart repo and install charts"
  block:
    - name: Get Helm charts list from repo before update 
      become: yes
      shell: helm search repo {{ helm_chart_repo_name }} --output json | jq -r '.[].name'
      register: helm_current_charts_list

    - name: "Add {{ helm_chart_repo_name }} Helm repository from url {{ repository_url }}"
      become: yes
      shell: helm repo add {{ helm_chart_repo_name }} {{ repository_url }}/helm-charts/system
      when: 
        - helm_chart_repo_name not in helm_repo.stdout 

    - name: Update Helm repo
      become: yes
      shell: helm repo update

    - name: Get Helm charts list from repo after update 
      become: yes
      shell: helm search repo {{ helm_chart_repo_name }} --output json | jq -r '.[].name'
      register: helm_charts_list

    - name: Delete not needed Helm charts 
      become: yes
      shell: |- 
        chart_subname=$(echo {{ item }} | cut -d "/" -f 2)
        helm delete $chart_subname
      loop: "{{ helm_current_charts_list.stdout_lines }}"
      when: item not in helm_charts_list.stdout_lines

    - name: Install Helm charts 
      become: yes
      shell: |- 
        chart_subname=$(echo {{ item }} | cut -d "/" -f 2)
        helm upgrade --install $chart_subname {{ item }}
      loop: "{{ helm_charts_list.stdout_lines }}"
  when: 
    - helm_charts_files_number.stdout|int > 2

