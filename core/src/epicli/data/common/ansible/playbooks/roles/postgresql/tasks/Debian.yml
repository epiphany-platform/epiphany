---
# Postgresql Debian family of specific tasks

- name: Install postgresql packages
  apt:
    name:
      - postgresql-10
      - postgresql-contrib-10
      - python-psycopg2 # required for postresql ansible management
    update_cache: yes
    state: present

- name: Install pgaudit packages
  apt:
    name:
      - postgresql-10-pgaudit
    update_cache: yes
    state: present
  when:
    - specification.additional_config is defined
    - specification.additional_config | selectattr('value','contains','pgaudit')

- name: Changing pg_hba.conf
  replace:
    path: /etc/postgresql/10/main/pg_hba.conf
    regexp: '^host.*?all.*?all.*?127\.0\.0\.1\/32.*?md5$'
    replace: 'host    all             all   0.0.0.0/0            md5'
    backup: yes

- name: Changing postgresql.conf
  replace:
    path: /etc/postgresql/10/main/postgresql.conf
    regexp: "#listen_addresses = 'localhost'"
    replace: "listen_addresses = '*'"
    backup: yes

- name: Add additional configuration to postgresql.conf
  lineinfile:
    path: /etc/postgresql/10/main/postgresql.conf
    insertafter: '^# Add settings for extensions here'
    line: "{{ item.name }} = '{{ item.value }}'"
  with_items:
    - "{{ specification.additional_config }}"
  when:
    - specification.additional_config is defined
    - specification.additional_config | list | length > 0

- name: Restart postgresql service
  service:
    name: postgresql
    state: restarted
    enabled: yes

- name: Set up replication
  include_tasks: "replication-Debian.yml"
  when:
    - specification.replication is defined and specification.replication.enable is defined and specification.replication.enable

- name: Install pgbouncer package
  apt:
    name:
      - pgbouncer
    update_cache: yes
    state: present
  when:
    - specification.additional_components is defined
    - specification.additional_components.pgbouncer.enable

- name: Changing pgbouncer configuration
  lineinfile:
    path: /etc/pgbouncer/pgbouncer.ini
    insertafter: '\[databases\]'
    line: postgres = host=127.0.0.1 port=5432 dbname=postgres
    backup: yes
  when:
    - specification.additional_components is defined
    - specification.additional_components.pgbouncer.enable

- name: Changing pool mode
  lineinfile:
    path: /etc/pgbouncer/pgbouncer.ini
    regexp: '^pool_mode ='
    replace: "pool_mode = transaction"
  when:
    - specification.additional_components is defined
    - specification.additional_components.pgbouncer.enable


- name: Changing pgbouncer users configuration
  lineinfile:
    path: /etc/pgbouncer/userlist.txt
    line: '"postgres" "*"'
    create: yes
    backup: yes
  when:
    - specification.additional_components is defined
    - specification.additional_components.pgbouncer.enable

- name: Restart pgbouncer service
  service:
    name: pgbouncer
    state: restarted
    enabled: yes
  when:
    - specification.additional_components is defined
    - specification.additional_components.pgbouncer.enable