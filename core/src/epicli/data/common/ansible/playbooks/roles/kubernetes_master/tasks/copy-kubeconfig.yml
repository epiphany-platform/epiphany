---
- name: Check if kubernetes-secrets.yml file exists
  delegate_to: localhost
  become: false
  stat:
    path: "{{ vault_location }}/kubernetes-secrets.yml"
    get_attributes: false
    get_checksum: false
    get_mime: false
  register: stat_kubernetes_secrets_yml

- name: Create kubeconfig files
  when: stat_kubernetes_secrets_yml.stat.exists
  block:
    - name: Create local kubeconfig file
      delegate_to: localhost
      become: false
      block:
        - name: Load vars from kubernetes-secrets.yml file
          include_vars:
            file: "{{ vault_location }}/kubernetes-secrets.yml"

        - name: Create local kubeconfig file
          template:
            src: kubeconfig.j2
            dest: "{{ inventory_dir }}/kubeconfig"
            mode: u=rw,g=,o=
          vars:
            api_server_as_localhost: true

    # Please notice this task file can be executed from other playbooks,
    # hence the fallback "default(groups.kubernetes_master.0)" must be defined.
    - name: Create remote kubeconfig file
      delegate_to: "{{ kubernetes_common.automation_designated_master | default(groups.kubernetes_master.0) }}"
      become: false
      block:
        - name: Create remote .kube directory
          file:
            path: "/home/{{ admin_user.name }}/.kube/"
            state: directory

        - name: Create remote kubeconfig file
          template:
            src: kubeconfig.j2
            dest: "/home/{{ admin_user.name }}/.kube/config"
            mode: u=rw,g=,o=
