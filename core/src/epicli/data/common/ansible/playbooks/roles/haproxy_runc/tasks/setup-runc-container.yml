---
- name: Assert input parameters
  assert:
    that:
      - runc_dir is defined
      - haproxy_service is defined
      - haproxy_image_tag is defined
      - haproxy_image is defined

- name: Set haproxy related facts
  set_fact:
    haproxy_dir: "{{ runc_dir }}/{{ haproxy_service }}"
    haproxy_archive: /tmp/haproxy-{{ haproxy_image_tag }}.tar

- name: Pull and export haproxy docker container
  shell: |
    docker pull {{ haproxy_image }} && docker export $(docker create {{ haproxy_image }}) --output {{ haproxy_archive }}
  args:
    creates: "{{ haproxy_archive }}"

- name: Extract haproxy container archive
  shell: |
    install -d {{ haproxy_dir }}/rootfs/ && tar xpf {{ haproxy_archive }} -C {{ haproxy_dir }}/rootfs/
  args:
    creates: "{{ haproxy_dir }}/rootfs/"

- name: Create initial config.json file
  shell: |
    runc spec
  args:
    chdir: "{{ haproxy_dir }}/"
    creates: "{{ haproxy_dir }}/config.json"

- name: Slurp config.json file contents
  slurp:
    src: "{{ haproxy_dir }}/config.json"
  register: slurp_config_json

- name: Adjust and save config.json file contents
  copy:
    dest: "{{ haproxy_dir }}/config.json"
    # Update and render json payload
    content: |
      {{ _document | combine(_update, recursive=true) | to_nice_json }}
  vars:
    # Parse json payload
    _document: >-
      {{ slurp_config_json.content | b64decode | from_json }}
    # Define extra volume mounts
    _mounts:
      - destination: /usr/local/etc/haproxy/haproxy.cfg
        source: /etc/haproxy/{{ haproxy_service }}.cfg
        type: bind
        options: [rbind, ro]
    # Assemble document update
    _update:
      process:
        args: [/usr/local/sbin/haproxy, -f, /usr/local/etc/haproxy/haproxy.cfg]
        terminal: false  # required for running it detached
      linux:
        # Remove "network" namespace to enable "host-networking"
        namespaces: >-
          {{ _document.linux.namespaces | selectattr('type', '!=', 'network') | list }}
      # Merge cointainer's volume / mount definitions
      mounts: >-
        {{ (_document.mounts + _mounts) | unique }}
