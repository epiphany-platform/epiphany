---
# Filebeat

- name: Download Filebeat v{{ specification.filebeat_version }}
  include_role:
    name: download
    tasks_from: download_package
  vars:
    package_arg: "{{ dependencies.filebeat[specification.filebeat_version].packages | selectattr('id', 'equalto', filebeat-oss) | list | first }}"

- name: Install {{ package_name }} from {{ file.dest_path }}
  package:
    name: "{{ file.dest_path }}"
    state: present

- name: Include configuration tasks
  include_tasks: configure-filebeat.yml

# Trigger restart if configuration has changed
- name: Flush handlers
  meta: flush_handlers

- name: Start Filebeat service
  systemd:
    name: filebeat
    state: started

- name: Verify Filebeat is running
  command: systemctl is-active filebeat
  changed_when: false
