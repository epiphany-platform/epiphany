---
- name: Assert that the "snapshot_name" fact is defined and valid
  assert:
    that:
      - snapshot_name is defined
      - snapshot_name is string
      - snapshot_name | length > 0
    fail_msg: The "snapshot_name" fact must be defined and must be a non-empty string.

- name: Create and copy etc archive to backup destination
  always:
    - name: Delete etc archive (cleanup)
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ backup_dir }}/kibana_etc_{{ snapshot_name }}.tar.gz"
        - "{{ backup_dir }}/kibana_etc_{{ snapshot_name }}.tar.gz.sha1"

  block:
    - name: Ensure backup dir exists
      file:
        path: "{{ backup_dir }}/"
        state: directory

    - name: Create etc archive
      archive:
        dest: "{{ backup_dir }}/kibana_etc_{{ snapshot_name }}.tar.gz"
        path: /etc/kibana/  # keep the / here!
        format: gz

    - name: Calculate checksum from etc archive
      stat:
        path: "{{ backup_dir }}/kibana_etc_{{ snapshot_name }}.tar.gz"
        get_attributes: false
        get_checksum: true
        get_mime: false
        checksum_algorithm: sha1
      register: stat_etc_archive

    - name: Store etc archive checksum in a file
      copy:
        dest: "{{ backup_dir }}/kibana_etc_{{ snapshot_name }}.tar.gz.sha1"
        content: |
          {{ stat_etc_archive.stat.checksum }}  kibana_etc_{{ snapshot_name }}.tar.gz

    - name: Transfer etc archive via rsync
      import_tasks: download_via_rsync.yml
      vars:
        artifacts:
          - "{{ backup_dir }}/kibana_etc_{{ snapshot_name }}.tar.gz"
          - "{{ backup_dir }}/kibana_etc_{{ snapshot_name }}.tar.gz.sha1"
