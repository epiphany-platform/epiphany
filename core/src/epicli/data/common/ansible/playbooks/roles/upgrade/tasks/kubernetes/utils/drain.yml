---
- name: upgrade | Wait for cluster's readiness
  include_tasks: kubernetes/utils/wait.yml

- when:
    - groups.kubernetes_node is defined
    - groups.kubernetes_node | length > 0  # drain only if there is at least one worker node
  block:
    - delegate_to: "{{ groups.kubernetes_master[0] }}"
      run_once: true
      environment:
        KUBECONFIG: /home/{{ admin_user.name }}/.kube/config
      block:
        - name: upgrade | Drain master or node in preparation for maintenance
          command: >-
            kubectl drain {{ inventory_hostname }} --ignore-daemonsets --delete-local-data

    - name: upgrade | Wait for cluster's readiness
      include_tasks: kubernetes/utils/wait.yml
