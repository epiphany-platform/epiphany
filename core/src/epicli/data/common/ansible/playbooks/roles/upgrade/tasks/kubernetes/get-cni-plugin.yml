---
- name: k8s/master | Check which CNI plugin is installed
  vars:
    kubectl_get_ds_cmd: >-
      kubectl get daemonsets -n kube-system -o=json | jq --raw-output
      '.items[].metadata | select (.labels."k8s-app" == "canal"
                                or .labels."k8s-app" == "calico-node"
                                or .labels.app == "flannel") | .name'
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  block:
    - name: k8s/master | Check which CNI plugin is installed
      shell: >-
        {{ kubectl_get_ds_cmd }}
      changed_when: false
      register: shell_plugin_query
      args:
        executable: /bin/bash
  rescue:
    - name: Print caught exception info before trying rescue task
      debug:
        var: shell_plugin_query

    # 'kubectl api-resources --cached=false' is used to avoid errors like:
    # Error from server (NotFound): Unable to find \"extensions/v1beta1, Resource=daemonsets\" that match label selector \"k8s-app=canal\"
    - name: k8s/master | Check which CNI plugin is installed (rescue task)
      shell: >-
        kubectl api-resources --cached=false &&
        {{ kubectl_get_ds_cmd }}
      changed_when: false
      register: shell_plugin_query
      args:
        executable: /bin/bash

- name: k8s/master | Set CNI plugin as fact
  set_fact:
    cni_plugin_name: >-
      {%- if 'kube-flannel-ds' in shell_plugin_query.stdout -%}
        flannel
      {%- elif 'canal' in shell_plugin_query.stdout -%}
        canal
      {%- elif 'calico-node' in shell_plugin_query.stdout -%}
        calico
      {%- else -%}
        unknown
      {%- endif -%}

- name: k8s/master | Assert CNI plugin was found
  assert:
    that:
      - cni_plugin_name != 'unknown'
    fail_msg: CNI plugin not found
    success_msg: "CNI plugin: {{ cni_plugin_name }}"
