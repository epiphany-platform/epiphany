---
- name: Include get-cluster-version.yml
  include_tasks: kubernetes/get-cluster-version.yml # sets cluster_version

- name: Include get-kubelet-version.yml
  include_tasks: kubernetes/get-kubelet-version.yml # sets kubelet_version

- name: Reconfigure Docker for pulling images from local registry
  block:
    - name: Include get-registries.yml from docker role # this sets result
      include_role:
        name: docker
        tasks_from: get-registries

    - name: Reconfigure Docker if necessary # this restarts Docker daemon
      include_role:
        name: docker
        tasks_from: configure-docker
      when:
        - not image_registry_address in result.stdout

- name: Upgrade master to v{{ version }}
  include_tasks: kubernetes/upgrade-master.yml
  vars:
    version: "{{ ver }}"
    cni_version: "{{ cni_ver }}"
  when:
    - groups['kubernetes_master'][0] == inventory_hostname
    - cluster_version.stdout is version('v' + version, '<=')

- name: Upgrade node to v{{ version }}
  include_tasks: kubernetes/upgrade-node.yml
  vars:
    version: "{{ ver }}"
    cni_version: "{{ cni_ver }}"
  when:
    - inventory_hostname in groups['kubernetes_node']
    - kubelet_version.stdout is version('v' + version, '<=')