---
- name: Include wait-for-kube-apiserver.yml
  import_tasks: kubernetes/wait-for-kube-apiserver.yml
  delegate_to: "{{ groups['kubernetes_master'][0] }}"

- name: Include get-cluster-version.yml
  import_tasks: kubernetes/get-cluster-version.yml # sets cluster_version
  delegate_to: "{{ groups['kubernetes_master'][0] }}"

- name: Check if upgrade from current K8s version is supported
  assert:
    that: cluster_version is version('v1.14.6', '>=')
    fail_msg: Your Kubernetes version ({{ cluster_version }}) is not supported by this version of Epiphany which requires at least version 1.14.6 (Epiphany v0.4.4). For more information, refer to the documentation.
    quiet: true

- name: Include get-kubelet-version.yml
  import_tasks: kubernetes/get-kubelet-version.yml # sets kubelet_version
  delegate_to: "{{ groups['kubernetes_master'][0] }}"

- name: Upgrade master to v{{ version }}
  include_tasks: kubernetes/upgrade-master.yml
  vars:
    version: "{{ ver }}"
    cni_version: "{{ cni_ver }}"
  when:
    - groups['kubernetes_master'][0] == inventory_hostname
    - cluster_version is version('v' + version, '<=')

- name: Upgrade node to v{{ version }}
  include_tasks: kubernetes/upgrade-node.yml
  vars:
    version: "{{ ver }}"
    cni_version: "{{ cni_ver }}"
  when:
    - groups['kubernetes_node'] is defined
    - inventory_hostname in groups['kubernetes_node']
    - kubelet_version is version('v' + version, '<=')
