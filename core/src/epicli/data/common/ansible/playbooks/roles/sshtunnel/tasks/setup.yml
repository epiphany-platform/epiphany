---
# Close tunnel if exists and assert port is free
- name: Include SSH tunnel teardown tasks
  include_tasks: teardown.yml

- name: Start SSH tunnel to K8s master
  shell: >-
    autossh -M 0 -f
    {{ admin_user.name }}@{{ k8s_master_ip }} -L {{ k8s_api_server_port }}:localhost:{{ k8s_api_server_port }}
    -i {{ admin_user.key_path }} -4 -N
    -o ServerAliveInterval=30 -o ServerAliveCountMax=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
  environment:
    AUTOSSH_PIDFILE: "{{ k8s_api_server.autossh_pid_file_path }}"

- name: Assert port {{ k8s_api_server_port }} is open
  wait_for:
    port: "{{ k8s_api_server_port }}"
    state: started
    timeout: 20
    msg: Timeout waiting for port {{ k8s_api_server_port }} to respond
