---
# Close tunnel if exists and assert port is free
- name: Include SSH tunnel teardown tasks
  include_tasks: teardown.yml

- name: Start SSH tunnel to K8s master
  block:
    - name: Start SSH tunnel to K8s master
      shell: >-
        autossh -M 0 -f
        {{ admin_user.name }}@{{ k8s_master_ip }} -L {{ k8s_api_server_port }}:localhost:{{ k8s_api_server_port }}
        -i $(readlink -f {{ admin_user.key_path }}) -4 -N -T
        -o BatchMode=yes -o ControlMaster=no -o ExitOnForwardFailure=yes -o ServerAliveInterval=30 -o ServerAliveCountMax=5
        -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
      args:
        chdir: "{{ lookup('env', 'PWD') }}" # chdir + readlink is to support relative path in admin_user.key_path
      register: shell_autossh
      environment: "{{ autossh_env }}"

    - name: Assert port {{ k8s_api_server_port }} is open
      wait_for:
        port: "{{ k8s_api_server_port }}"
        state: started
        timeout: 15
        msg: |-
          Timeout waiting for port {{ k8s_api_server_port }} to respond.
          Command used to start the tunnel: '{{ shell_autossh.cmd }}'
          Environment: {{ autossh_env }}
  vars:
    autossh_env:
      AUTOSSH_LOGFILE: "{{ k8s_api_server.autossh_log_file_path }}"
      AUTOSSH_PIDFILE: "{{ k8s_api_server.autossh_pid_file_path }}"
