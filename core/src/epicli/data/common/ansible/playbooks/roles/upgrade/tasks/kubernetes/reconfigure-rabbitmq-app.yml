---
- name: Change rabbitmq stateful set to use {{ image_registry_address }}
  run_once: true
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  block:
    - name: upgrade-master | Get rabbitmq statefulset name
      shell: |-
        kubectl get statefulsets.apps --all-namespaces -o=jsonpath={{ _jsonpath }} |
        grep -i rabbitmq |
        awk '{print $1}'
      vars:
        _jsonpath: >-
          '{range .items[*]}{.metadata.name}{"\t"}{.spec.template.spec.containers[].image}{"\n"}{end}'
      changed_when: false
      register: rabbit_mq_ss_name
      args: &args
        executable: /bin/bash

    - name: upgrade-master | Get rabbitmq namespace
      shell: |-
        kubectl get statefulsets.apps --all-namespaces -o=jsonpath={{ _jsonpath }} |
        grep -i rabbitmq |
        awk '{print $1}'
      vars:
        _jsonpath: >-
          '{range .items[*]}{.metadata.namespace}{"\t"}{.spec.template.spec.containers[].image}{"\n"}{end}'
      changed_when: false
      register: rabbit_mq_namespace
      args: *args

    - name: upgrade-master | Get rabbitmq image
      shell: |-
        kubectl get statefulsets.apps {{ rabbit_mq_ss_name.stdout }} -n {{ rabbit_mq_namespace.stdout }} -o=jsonpath={{ _jsonpath }}
      vars:
        _jsonpath: >-
          '{$.spec.template.spec.containers[:1].image}'
      changed_when: false
      register: rabbit_mq_repository
      when:
        - not rabbit_mq_namespace.stdout == ""

    - name: upgrade-master | Patch rabbitmq to use {{ image_registry_address }}
      shell: |-
        kubectl patch statefulsets.apps {{ rabbit_mq_ss_name.stdout }} -n {{ rabbit_mq_namespace.stdout }} --patch '{{ _patch | to_json }}'
      vars:
        _patch:
          spec:
            template:
              spec:
                containers:
                  - name: "{{ rabbit_mq_ss_name.stdout }}"
                    image: "{{ image_registry_address }}/{{ rabbit_mq_repository.stdout }}"
      when:
        - not rabbit_mq_namespace.stdout == ""
        - not image_registry_address in rabbit_mq_repository.stdout
