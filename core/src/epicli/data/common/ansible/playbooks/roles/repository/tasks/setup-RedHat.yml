---
- name: Create epirepo repository
  shell: /tmp/epi-repository-setup-scripts/create-repository.sh /shared/requirements {{ offline_mode }}
  when:
    - groups['kubernetes_master'][0] == inventory_hostname

- name: Disable system repositories and setup epirepo for offline mode
  block:
    - name: Create active repositories list
      shell: /tmp/epi-repository-setup-scripts/generate-enabled-system-repository-list.sh
    - name: Disable active system repositories
      shell: /tmp/epi-repository-setup-scripts/disable-system-repos.sh
    - name: Setup epirepo on clients
      shell: /tmp/epi-repository-setup-scripts/setup-epirepo-client-rh.sh {{ hostvars[groups['kubernetes_master'][0]]['ansible_default_ipv4']['address'] }}
  when:
    - offline_mode == true

- name: Disable system repositories and setup epirepo for online mode
  block:
    - name: Create active repositories list
      shell: /tmp/epi-repository-setup-scripts/generate-enabled-system-repository-list.sh
    - name: Disable active system repositories
      shell: /tmp/epi-repository-setup-scripts/disable-system-repos.sh
    - name: Setup epirepo on clients
      shell: /tmp/epi-repository-setup-scripts/setup-epirepo-client-rh.sh {{ groups['kubernetes_master'][0] }}
  when:
    - not groups['kubernetes_master'][0] == inventory_hostname
    - offline_mode == false
