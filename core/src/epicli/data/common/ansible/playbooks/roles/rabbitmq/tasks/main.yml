---
- include_tasks: "set-variables.yml"

- name: prepare list of packages for RabbitMQ v{{ specification.version }}
  set_fact:
    packages_to_install: "{{ dependencies.rabbitmq[specification.version].packages | list }}"

- name: Install RabbitMQ v{{ package_version }}
  include_role:
    name: install
    tasks_from: install_packages
  vars:
    packages_list: "{{ packages_to_install }}"

- include_tasks: "set-erlang-cookie.yml"
  when: is_clustered and groups['rabbitmq'] | length > 1

- include_tasks: "configure-rabbitmq.yml"

- include_tasks: "enable-and-start-service.yml"

- include_tasks: "set-logrotate.yml"

- include_tasks: "set-ulimits.yml"

- include_tasks: "join-cluster.yml"
  when: is_clustered and groups['rabbitmq'] | length > 1

- include_tasks: "configure-policies.yml"
