---
- name: Prepare backend configuration for HAProxy
  set_fact:
    kubernetes_common: >-
      {{ kubernetes_common | default({}) | combine(set_fact, recursive=true) }}
  vars:
    set_fact:
      haproxy_master_names: >-
        {{ groups.kubernetes_master
        | map('extract', hostvars, ['inventory_hostname'])
        | list }}
      haproxy_master_ipv4s: >-
        {{ groups.kubernetes_master
        | map('extract', hostvars, ['ansible_default_ipv4', 'address'])
        | list }}

- name: Prepare backend configuration for HAProxy
  set_fact:
    kubernetes_common: >-
      {{ kubernetes_common | default({}) | combine(set_fact, recursive=true) }}
  vars:
    set_fact:
      haproxy_backend_servers: >-
        {{ kubernetes_common.haproxy_master_names | zip(kubernetes_common.haproxy_master_ipv4s) | list }}

- name: Ensure /etc/haproxy directory exists
  file:
    path: /etc/haproxy/
    state: directory

- name: Configure and start haproxy
  vars:
    haproxy_service: haproxy-k8s
  block:
    - name: Render haproxy config
      template:
        dest: /etc/haproxy/{{ haproxy_service }}.cfg
        src: haproxy.cfg.j2

    - name: Setup and start {{ haproxy_service }} runc-based systemd service
      include_role:
        name: haproxy_runc
