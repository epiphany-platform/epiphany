---
- name: verify-upgrade | Verify cluster versions
  environment:
    KUBECONFIG: /home/{{ admin_user.name }}/.kube/config
  block:
    - name: Verify cluster version
      when:
        - inventory_hostname in groups.kubernetes_master
      block:
        - name: verify-upgrade | Include wait-for-kube-apiserver.yml
          include_tasks: utils/wait-for-kube-apiserver.yml

        - name: verify-upgrade | Include get-cluster-version.yml
          include_tasks: get-cluster-version.yml  # sets cluster_version

        - name: verify-upgrade | Verify cluster version
          assert:
            that: version in cluster_version

    - name: Verify kubectl version
      block:
        - name: verify-upgrade | Get kubectl version
          shell: |-
            set -o pipefail &&
            kubectl version --client --short -o json | jq --raw-output '.clientVersion.gitVersion'
          register: kubectl_version
          args: &args
            executable: /bin/bash
          changed_when: false

        - name: verify-upgrade | Verify kubectl version
          assert:
            that: version in kubectl_version.stdout

    - name: Verify kubeadm version
      block:
        - name: verify-upgrade | Get kubeadm version
          command: >-
            kubeadm version -o short
          register: kubeadm_version
          changed_when: false

        - name: verify-upgrade | Verify kubeadm version
          assert:
            that: version in kubeadm_version.stdout

    - name: verify-upgrade | Verify kubelet version from API server and get node status
      run_once: true
      shell: |-
        set -o pipefail &&
        kubectl get nodes {{ inventory_hostname }} |
        # get values only for STATUS and VERSION columns, example output: 'Ready v1.14.6'
        awk 'NR==1 { for (col=1; col<=NF; col++) { columns[$col] = col } };
             NR>1  { print $columns["STATUS"], $columns["VERSION"] }'
      register: node_status_and_version
      until:
        - version in node_status_and_version.stdout
      retries: 30 # 1min
      delay: 2
      args: *args
      changed_when: false

    - name: verify-upgrade | Verify node status
      assert:
        that: "'Ready' in node_status_and_version.stdout"
