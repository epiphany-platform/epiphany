---
- name: Assert that the "artifacts" fact is defined and valid
  assert:
    that:
      - artifacts is defined
      - artifacts | type_debug == 'list'
      - artifacts | length > 0
    fail_msg: The "artifacts" fact must be defined and must be a non-empty list.

- name: Upload artifacts to mounted storage
  vars:
    private_key_path: "~/.ssh/id_rsa_{{ inventory_hostname_short }}"

  delegate_to: "{{ backup_destination_host }}"

  always:
    - name: Delete generated files
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ private_key_path }}"
        - "{{ private_key_path }}.pub"

    - delegate_to: "{{ inventory_hostname }}"  # cancel previous delegate_to
      block:
        - name: Remove public openssh key from admin's authorized_keys
          authorized_key:
            user: "{{ admin_user.name }}"
            state: absent
            key: >-
              {{ openssh_keypair.public_key }}

  block:
    - name: Generate openssh keypair for rsync over ssh
      openssh_keypair:
        path: "{{ private_key_path }}"
        size: 2048
      register: openssh_keypair

    - delegate_to: "{{ inventory_hostname }}"  # cancel previous delegate_to
      block:
        - name: Add public openssh key to admin's authorized_keys
          authorized_key:
            user: "{{ admin_user.name }}"
            state: present
            key: >-
              {{ openssh_keypair.public_key }}

    - name: Ensure destination directory for artifacts exists
      file:
        path: "{{ backup_destination_dir }}"
        state: directory

    - name: Use rsync to copy all artifacts
      synchronize:
        mode: pull
        dest: "{{ backup_destination_dir }}"
        src: "{{ item }}"
        checksum: true
        rsync_opts:
          - --rsh={{ rsh }}
      vars:
        # this fixes / replaces incorrect path to the private key file that synchronize provides
        # (setting private_key parameter has no effect whatsoever, looks like a bug tbh)
        rsh: >-
          /usr/bin/ssh -S none -i {{ private_key_path }} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
      loop: "{{ artifacts }}"
