kind: configuration/applications
title: "Kubernetes Applications Config"
name: default
specification:
  applications:
  # - name: ignite-stateless
  #   image_path: "apacheignite/ignite:2.5.0" # it will be part of the image path: {{local_repository}}/{{image_path}}
  #   namespace: ignite
  #   service:
  #     rest_nodeport: 32300
  #     sql_nodeport: 32301
  #     thinclients_nodeport: 32302
  #   replicas: 1
  #   enabled_plugins:
  #   - ignite-kubernetes # required to work on K8s
  #   - ignite-rest-http

# Abstract these configs to seperate default files and add 
# the ability to add custom application roles.

# - name: rabbitmq 2
#   image_path: rabbitmq:3.7.10
#   use_local_image_registry: true
#   #image_pull_secret_name: regcred # optional
#   service:
#     name: rabbitmq-cluster
#     port: 30672
#     management_port: 31672
#     replicas: 2
#     namespace: queue
#   rabbitmq:
#     #amqp_port: 5672 #optional - default 5672
#     plugins: # optional list of RabbitMQ plugins
#       - rabbitmq_management
#       - rabbitmq_management_agent
#     policies: # optional list of RabbitMQ policies
#       - name: ha-policy2
#         pattern: ".*"
#         definitions:
#           ha-mode: all
#     custom_configurations: #optional list of RabbitMQ configurations (new format -> https://www.rabbitmq.com/configure.html)
#       - name: vm_memory_high_watermark.relative
#         value: 0.5
#     cluster:
#       #is_clustered: true #redundant in in-Kubernetes installation, it will always be clustered
#       #cookie: "cookieSetFromDataYaml" #optional - default value will be random generated string


# - name: auth-service # this service requires PostgreSQL to be installed in cluster
#   image_path: jboss/keycloak:4.8.3.Final
#   use_local_image_registry: true
#   #image_pull_secret_name: regcred
#   service:
#     name: as-testauthdb
#     port: 30104
#     replicas: 2
#     namespace: namespace-for-auth
#     admin_user: auth-service-username
#     admin_password: auth-service-password
#   database: 
#     name: "auth-database-name"
#     #port: "5432" # leave it when default
#     user: "auth-db-user"
#     password: "auth-db-password"

## --- Pgpool ---

  - name: pgpool # this service requires PostgreSQL to be installed in cluster
    enabled: yes
    image:
      path: bitnami/pgpool:4.1.1
      debug: no # ref: https://github.com/bitnami/minideb-extras/#turn-on-bash-debugging
    namespace: pgpool
    service:
      name: pgpool
      port: 5432
    replicas: 2
    pod_spec:
      affinity: {}
      nodeSelector: {}
      tolerations: {}
    resources:
      limits:
        memory: 256Mi
      requests:
        cpu: 250m
        memory: 256Mi
    pgpool:
      # https://github.com/bitnami/bitnami-docker-pgpool#configuration + https://github.com/bitnami/bitnami-docker-pgpool#environment-variables
      env:
        PGPOOL_BACKEND_NODES: SET_BY_AUTOMATION # e.g. 0:pg-node-0:5432,1:pg-node-1:5432
        PGPOOL_POSTGRES_USERNAME: postgres # administrator user, used to allow postgres admin authentication through pgpool
        PGPOOL_TIMEOUT: 360
        PGPOOL_ADMIN_USERNAME: admin
        PGPOOL_ENABLE_LOAD_BALANCING: "yes" # allowed: yes or no
        PGPOOL_MAX_POOL: 15
        PGPOOL_POSTGRES_PASSWORD_FILE: /opt/bitnami/pgpool/secrets/pgpool-password
        PGPOOL_ADMIN_PASSWORD_FILE: /opt/bitnami/pgpool/secrets/admin-password
        PGPOOL_SR_CHECK_USER: postgresql-replication-user # TODO: test, user added becouse of: ERROR ==> The PostrgreSQL replication credentials are mandatory. Set the environment variables PGPOOL_SR_CHECK_USER and PGPOOL_SR_CHECK_PASSWORD with the PostrgreSQL replication credentials.
      secrets:
        pgpool_postgres_password: adminpassword
        pgpool_admin_password: adminpassword
        pgpool_sr_check_password: postgresql-replication-password # TODO: test
      config_file_content : |
        # Specify content for pgpool.conf
        # TODO: To be implemented
        # Example: https://github.com/CrunchyData/crunchy-containers/blob/master/examples/kube/pgpool/configs/pgpool.conf
