kind: configuration/postgresql
name: default
provider: aws
specification:
  additional_components:
    pgbouncer:
      enabled: false
  config_file:
    parameter_groups:
    - name: CONNECTIONS AND AUTHENTICATION
      subgroups:
      - name: Connection Settings
        parameters:
        - comment: listen on all addresses
          name: listen_addresses
          value: '''*'''
      - name: Security and Authentication
        parameters:
        - comment: to have the default value also on Ubuntu
          name: ssl
          value: 'off'
    - name: RESOURCE USAGE (except WAL)
      subgroups:
      - name: Kernel Resource Usage
        parameters:
        - comment: set by automation
          name: shared_preload_libraries
          value: SET_BY_AUTOMATION
    - name: WAL LOG SETTINGS
      subgroups:
      - name: WAL log settings
        parameters:
        - comment: maximum numeber of WAL senders
          name: max_wal_senders
          value: 10
        - comment: maximum numeber of segments kept
          name: wal_keep_segments
          value: 34
        - comment: WAL level
          name: wal_level
          value: replica
    - name: Archive settings  
      subgroups:
      - name: Archive settings
        parameters:
        - comment: archive mode
          name: archive_mode
          value: on
        - comment: archive command
          name: archive_command
          value: '''test ! -f /dbbackup/{{ inventory_hostname }}/backup/%f && gzip -c < %p > /dbbackup/{{ inventory_hostname }}/backup/%f'''
    - name: ERROR REPORTING AND LOGGING
      subgroups:
      - name: Where to Log
        parameters:
        - comment: to have standard location for Filebeat and logrotate
          name: log_directory
          value: '''/var/log/postgresql'''
        - comment: to use logrotate with common configuration
          name: log_filename
          value: '''postgresql.log'''
  extensions:
    pgaudit:
      config_file_parameters:
        log_connections: 'off'
        log_disconnections: 'off'
        log_line_prefix: '''%m [%p] %q%u@%d,host=%h '''
        log_statement: none
        pgaudit.log: '''write, function, role, ddl'' # ''misc_set'' is not supported
          for PG 10'
        pgaudit.log_catalog: 'off # to reduce overhead of logging'
        pgaudit.log_parameter: 'on'
        pgaudit.log_relation: 'on # separate log entry for each relation'
        pgaudit.log_statement_once: 'off'
      enabled: false
      shared_preload_libraries:
      - pgaudit
    replication:
      enabled: false
      replication_user_name: repmgr
      replication_user_password: PASSWORD_TO_CHANGE
      priviledged_user_name: postgres
      priviledged_user_password: PASSWORD_TO_CHANGE
      use_repmgr: true
      repmgr_database: repmgr
      shared_preload_libraries:
      - repmgr
  logrotate:
    config: "/var/log/postgresql/postgresql*.log {\n    maxsize 10M\n    daily\n \
      \   rotate 6\n    copytruncate\n# delaycompress is for Filebeat\n    delaycompress\n\
      \    compress\n    notifempty\n    missingok\n    su root root\n    nomail\n\
      # to have multiple unique filenames per day when dateext option is set\n   \
      \ dateformat -%Y%m%d-%H\n}"
  provider: aws
title: PostgreSQL
version: 0.5.2
